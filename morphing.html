<!DOCTYPE html>
<html>
<meta charset="utf-8">
<link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="node_modules/codemirror/theme/twilight.css">
<link rel="stylesheet" href="node_modules/codemirror-inlet/inlet.css" type="text/css" media="screen"  title="no title" charset="utf-8">
<style>
body {
  overflow: hidden;
}

iframe {
  background-color: #ecf0f1;
  border: none;
  overflow: hidden;
}
.html-editor-container {
  font-size: 14px;
}

</style>
<body>
</body>
<script src="scripts/d3.v3.js"></script>
<script src="scripts/debounce.js"></script>
<script src="scripts/template-modifier.js"></script>
<script src="node_modules/codemirror/lib/codemirror.js"></script>
<script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
<script src="node_modules/codemirror/mode/xml/xml.js"></script>
<script src="node_modules/codemirror/mode/css/css.js"></script>
<script src="node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
<script src="node_modules/codemirror-inlet/inlet.js"></script>
<script>
'use strict'

var width = window.innerWidth, height = window.innerHeight

var slug = window.location.hash.slice(1)

var defaultContent = '<!DOCTYPE html>
<head>
  <script src="/scripts/d3.v3.js" charset="utf-8"></script>
</head>
<body>
  <p>A</p>
  <svg width="510" height="600">
  </svg>
  <script type="text/javascript">
  var svg = d3.select("svg");
    
  var pstyle = {"fill":"none","fill-rule":"evenodd","stroke":"#000000","stroke-width":"1px","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-opacity":1};
    
  var d0 = "m 155.91263,141.13951 c 0,0 58.90033,-39.26689 81.99849,-8.08436 23.09817,31.18253 40.42179,32.33743 34.64725,61.21014 -5.77454,28.87271 -24.25307,55.4356 -48.50615,55.4356 -24.25307,0 -78.53377,-21.94325 -78.53377,-38.11197 0,-25.40799 -24.25307,-45.04143 10.39418,-70.44941 z";
  
  var d1 = "m 396.13357,181.5613 c 0,0 -38.11198,-17.32363 -31.18253,-50.81597 6.92945,-33.49234 38.11198,6.92945 54.28069,13.8589 16.16872,6.92945 30.02762,16.16872 42.73161,33.49235 12.70399,17.32362 17.32363,69.2945 -8.08436,64.67486 -33.14187,-17.75692 -36.26601,-41.39151 -57.74541,-61.21014 z";
   
  var path = svg.append("path");
    
  path.style(pstyle);
    
  loop();

  function loop() {
    path
        .attr("d", d0)
      .transition()
        .duration(5000)
        .attr("d", d1)
      .transition()
        .delay(5000)
        .attr("d", d0)
        .each("end", loop);
  }
  </script>
</body>
</html>';

if (slug)
  d3.text('./examples/' + slug + '.html', function(err, res) {
    gotContent(err ? defaultContent : res)
  })
else gotContent(defaultContent)

function gotContent(content) {

  var body = d3.select('body')

  var main = body.append('div')
    .style({
      width: width + 'px',
      height: height + 'px',
      position: 'absolute',
      top: '0px',
      left: '0px',
    })

  var iframe = main.append('iframe').classed('stage', true)
    .style({
      position: 'absolute',
      top: '0',
      left: width / 2 + 'px',
      width: width / 2 + 'px',
      height: height + 'px'
    })

  var htmlEditorContainer = main.append('div')
    .classed('html-editor-container', true)
    .style({
      width: width / 2 + 'px',
      height: height + 'px',
      position: 'absolute',
      top: '0',
      left: '0',
      border: 'none',
    })

  var htmlCM = CodeMirror(htmlEditorContainer.node(), {
    tabSize: 2,
    value: content,
    mode:  'htmlmixed',
    lineNumbers: true,
    theme: 'twilight',
    lineWrapping: true,
  })

  htmlCM.setSize(width / 2, height)

  htmlCM.on('change', function() {
    updateHTML()
  })
  Inlet(htmlCM)

  var blobUrl
  var updateHTML = debounce(function updateHTML() {
      var template = htmlCM.getValue()
      d3.xhr('./examples/' + slug + '.html')
        .header('Content-Type', 'text/html')
        .post(template, function(err, res) {
          if(err) throw err
        })
      template = templateModifier(template)
      //remove the last instance
      window.URL.revokeObjectURL(blobUrl)
      var blob = new Blob([template], {type: 'text/html'})
      blobUrl = URL.createObjectURL(blob)
      iframe.node().src = blobUrl
  }, 100)

  updateHTML()
}

</script>
</html>
